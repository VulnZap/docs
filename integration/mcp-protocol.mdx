---
title: "MCP Protocol"
description: "Model Context Protocol integration for AI-aware security scanning"
icon: "plug"
---

## Overview

VulnZap implements the Model Context Protocol (MCP), enabling seamless integration with AI coding assistants to provide real-time security guardrails during code generation.

## What is MCP?

The Model Context Protocol is an open standard that allows AI assistants to:
- Communicate with external tools and services
- Receive context-aware feedback
- Integrate specialized capabilities (like security scanning)
- Modify behavior based on tool responses

**VulnZap + MCP** = AI assistants that automatically generate secure code.

## How It Works

<Steps>
  <Step title="User Prompt">
    User asks AI assistant to generate code
    ```
    "Create a login endpoint with username and password"
    ```
  </Step>
  
  <Step title="AI Generates Code">
    Assistant generates initial implementation
    ```javascript
    app.post('/login', (req, res) => {
      const { username, password } = req.body;
      const user = db.query(
        `SELECT * FROM users WHERE username='${username}' 
         AND password='${password}'`
      );
      if (user) res.json({ token: username });
    });
    ```
  </Step>
  
  <Step title="MCP Intercept">
    Before applying code, VulnZap receives diff via MCP
  </Step>
  
  <Step title="Security Analysis">
    VulnZap analyzes the code and detects:
    - ❌ SQL Injection (critical)
    - ❌ Predictable session tokens
    - ❌ Plaintext password comparison
    - ❌ Missing rate limiting
  </Step>
  
  <Step title="Feedback to AI">
    VulnZap sends security context back through MCP:
    ```json
    {
      "vulnerabilities": [
        {
          "type": "sql_injection",
          "severity": "critical",
          "line": 4,
          "suggestion": "Use parameterized queries"
        },
        {
          "type": "weak_authentication",
          "severity": "critical",
          "suggestion": "Hash passwords with bcrypt"
        }
      ],
      "secure_alternative": "..."
    }
    ```
  </Step>
  
  <Step title="AI Regenerates">
    Assistant incorporates security feedback and generates secure version:
    ```javascript
    const rateLimit = require('express-rate-limit');
    const bcrypt = require('bcrypt');
    const jwt = require('jsonwebtoken');
    
    const loginLimiter = rateLimit({
      windowMs: 15 * 60 * 1000,
      max: 5
    });
    
    app.post('/login', loginLimiter, async (req, res) => {
      const { username, password } = req.body;
      
      const user = await db.query(
        'SELECT * FROM users WHERE username = ?',
        [username]
      );
      
      if (!user || !await bcrypt.compare(password, user.passwordHash)) {
        return res.status(401).json({ error: 'Invalid credentials' });
      }
      
      const token = jwt.sign(
        { userId: user.id },
        process.env.JWT_SECRET,
        { expiresIn: '1h' }
      );
      
      res.json({ token });
    });
    ```
  </Step>
  
  <Step title="Apply Secure Code">
    ✅ VulnZap approves secure implementation
    ✅ Code is applied to the editor
  </Step>
</Steps>

## Supported AI Assistants

<CardGroup cols={2}>
  <Card title="Cursor" icon="cursor">
    Native MCP support, zero configuration
  </Card>
  <Card title="Windsurf" icon="wind">
    Full MCP integration with VulnZap
  </Card>
  <Card title="Cline" icon="terminal">
    Agent-aware security scanning
  </Card>
  <Card title="VS Code with Copilot" icon="code">
    Via MCP extension (beta)
  </Card>
</CardGroup>

## Configuration

### Cursor

Add VulnZap MCP server in Cursor settings:

```json .cursor/mcp.json
{
  "mcpServers": {
    "vulnzap": {
      "command": "vulnzap",
      "args": ["mcp"],
      "env": {
        "VULNZAP_API_KEY": "your-api-key"
      }
    }
  }
}
```

### Windsurf

Windsurf auto-detects VulnZap MCP server:

1. Install VulnZap: `npm install -g vulnzap`
2. Authenticate: `vulnzap auth`
3. Start MCP server: `vulnzap mcp --daemon`
4. Windsurf automatically connects

### Cline

Configure in Cline settings:

```json
{
  "cline.mcpServers": [
    {
      "name": "vulnzap",
      "command": "vulnzap mcp",
      "enabled": true
    }
  ]
}
```

### VS Code (Beta)

Requires MCP extension:

```json settings.json
{
  "mcp.servers": {
    "vulnzap": {
      "command": "vulnzap",
      "args": ["mcp"],
      "enabled": true
    }
  }
}
```

## MCP Server Management

### Start MCP Server

```bash
# Foreground
vulnzap mcp

# Background daemon
vulnzap mcp --daemon

# Custom port
vulnzap mcp --port 3001

# Debug mode
vulnzap mcp --log-level debug
```

### Check Status

```bash
vulnzap mcp status
```

**Example Output:**

```
VulnZap MCP Server Status:
  Status: Running
  PID: 12345
  Port: 3000
  Uptime: 2 hours 34 minutes
  Connections: 1 active (Cursor)
  Requests: 142 total
  Last Activity: 3 seconds ago
```

### Stop Server

```bash
vulnzap mcp stop
```

### Restart Server

```bash
vulnzap mcp restart
```

## MCP Protocol Specification

### Request Format

IDE sends code generation request:

```json
{
  "method": "analyze",
  "params": {
    "code": "const query = `SELECT * FROM users WHERE id = ${id}`;",
    "language": "javascript",
    "context": {
      "file": "src/db/queries.js",
      "function": "getUserById",
      "prompt": "Create a database query function"
    }
  }
}
```

### Response Format

VulnZap returns analysis:

```json
{
  "status": "vulnerable",
  "risk_score": 95,
  "findings": [
    {
      "id": "finding_abc123",
      "type": "sql_injection",
      "severity": "critical",
      "line": 1,
      "column": 16,
      "message": "User input directly concatenated in SQL query",
      "cwe": "CWE-89",
      "owasp": "A03:2021",
      "fix": {
        "description": "Use parameterized queries",
        "code": "const query = 'SELECT * FROM users WHERE id = ?';\ndb.execute(query, [id]);"
      }
    }
  ],
  "recommendation": "apply_fix",
  "secure_alternative": "..."
}
```

### Package Check

IDE requests package installation approval:

```json
{
  "method": "check_package",
  "params": {
    "package": "lodash",
    "version": "4.17.15",
    "manager": "npm"
  }
}
```

**Response:**

```json
{
  "status": "vulnerable",
  "severity": "high",
  "cve": ["CVE-2020-8203"],
  "recommendation": "upgrade",
  "safe_version": "4.17.21",
  "action": "block"
}
```

## Integration Examples

### Example 1: SQL Injection Prevention

**User Prompt:**
> "Write a function to search users by email"

**AI Initial Code:**
```javascript
function searchUsersByEmail(email) {
  return db.query(`SELECT * FROM users WHERE email = '${email}'`);
}
```

**VulnZap MCP Response:**
```json
{
  "status": "vulnerable",
  "findings": [{
    "type": "sql_injection",
    "severity": "critical",
    "suggestion": "Use parameterized queries"
  }]
}
```

**AI Corrected Code:**
```javascript
function searchUsersByEmail(email) {
  return db.query('SELECT * FROM users WHERE email = ?', [email]);
}
```

### Example 2: XSS Prevention

**User Prompt:**
> "Display user comment in HTML"

**AI Initial Code:**
```javascript
function renderComment(comment) {
  return `<div class="comment">${comment.text}</div>`;
}
```

**VulnZap MCP Response:**
```json
{
  "status": "vulnerable",
  "findings": [{
    "type": "xss",
    "severity": "high",
    "suggestion": "Escape HTML entities"
  }]
}
```

**AI Corrected Code:**
```javascript
const escapeHtml = require('escape-html');

function renderComment(comment) {
  return `<div class="comment">${escapeHtml(comment.text)}</div>`;
}
```

### Example 3: Secure File Upload

**User Prompt:**
> "Create file upload endpoint"

**AI Initial Code:**
```javascript
app.post('/upload', (req, res) => {
  const filename = req.body.filename;
  fs.writeFileSync(`./uploads/${filename}`, req.body.data);
  res.send('OK');
});
```

**VulnZap MCP Response:**
```json
{
  "status": "vulnerable",
  "findings": [
    {
      "type": "path_traversal",
      "severity": "critical"
    },
    {
      "type": "missing_validation",
      "severity": "high"
    }
  ],
  "secure_alternative": "Use multer with validation"
}
```

**AI Corrected Code:**
```javascript
const multer = require('multer');
const path = require('path');

const storage = multer.diskStorage({
  destination: './uploads/',
  filename: (req, file, cb) => {
    const safeName = path.basename(file.originalname);
    cb(null, `${Date.now()}-${safeName}`);
  }
});

const upload = multer({
  storage,
  limits: { fileSize: 5 * 1024 * 1024 },
  fileFilter: (req, file, cb) => {
    const allowed = ['image/jpeg', 'image/png'];
    cb(null, allowed.includes(file.mimetype));
  }
});

app.post('/upload', upload.single('file'), (req, res) => {
  res.send('OK');
});
```

## Advanced Features

### Context-Aware Analysis

VulnZap considers the full context:

- **Framework Detection**: Express, Fastify, Django, Flask
- **Library Usage**: ORM (Sequelize, TypeORM), templating engines
- **Application Type**: Web app, API, CLI tool
- **Security Controls**: Existing middleware, validators

**Example:**

```javascript
// VulnZap detects Express + Helmet
const express = require('express');
const helmet = require('helmet');

const app = express();
app.use(helmet());

// Less strict on XSS since Helmet provides CSP
app.get('/page', (req, res) => {
  res.send(`<h1>${req.query.title}</h1>`);
  // Warning: XSS (Medium) instead of Critical
});
```

### Learning from Feedback

When you mark findings as false positives, VulnZap learns:

```bash
vulnzap feedback --finding finding_abc123 --false-positive \
  --reason "Using prepared statements library"
```

Future AI code generation will account for your patterns.

### Custom Security Rules

Define project-specific rules for AI to follow:

```yaml .vulnzap/mcp-rules.yml
rules:
  - name: require_auth_middleware
    when: creating_routes
    requirement: "All API routes must use authMiddleware"
    
  - name: no_inline_sql
    when: database_queries
    requirement: "Always use ORM or query builder, never raw SQL"
    
  - name: validate_all_inputs
    when: accepting_user_input
    requirement: "Use Joi or Zod for input validation"
```

AI assistants will follow these rules when generating code.

### Package Policy

Configure package installation policy:

```yaml .vulnzap/package-policy.yml
block:
  - packages_with_critical_cve
  - malicious_packages
  - typosquatting_attempts

warn:
  - packages_with_high_cve
  - unmaintained_packages
  - packages_without_types

allow:
  - specific_versions:
      lodash: ">=4.17.21"
      axios: ">=1.6.0"
```

## Performance

MCP integration is designed for real-time use:

| Operation | Latency | Notes |
|-----------|---------|-------|
| Code analysis | <100ms | Inline scanning |
| Package check | <50ms | Cached CVE database |
| Fix generation | <200ms | Context-aware patches |
| MCP round-trip | <150ms | Total latency |

**No noticeable delay** in AI code generation.

## Debugging

### Enable Debug Logging

```bash
vulnzap mcp --log-level debug
```

### View MCP Logs

```bash
tail -f ~/.vulnzap/logs/mcp.log
```

**Example Log:**

```
2025-10-19 14:32:11 [INFO] MCP server started on port 3000
2025-10-19 14:32:15 [INFO] Client connected: Cursor (v1.2.3)
2025-10-19 14:32:18 [DEBUG] Received request: analyze
2025-10-19 14:32:18 [DEBUG] Code language: javascript
2025-10-19 14:32:18 [DEBUG] Analysis completed: 1 finding (critical)
2025-10-19 14:32:18 [INFO] Response sent: status=vulnerable
```

### Test MCP Connection

```bash
vulnzap mcp test
```

**Output:**

```
Testing MCP Server Connection...

✅ Server is running
✅ Port 3000 is accessible
✅ Authentication successful
✅ Test scan completed
✅ Response parsing successful

MCP Server Status: Healthy
```

## Troubleshooting

<AccordionGroup>
  <Accordion title="AI Not Using VulnZap">
    **Symptoms:** AI generates insecure code without VulnZap feedback
    
    **Solutions:**
    1. Verify MCP server is running: `vulnzap mcp status`
    2. Check IDE MCP configuration
    3. Restart IDE to reload MCP servers
    4. Check logs: `tail -f ~/.vulnzap/logs/mcp.log`
  </Accordion>
  
  <Accordion title="Connection Refused">
    **Error:** `MCP connection refused on port 3000`
    
    **Solutions:**
    - Start MCP server: `vulnzap mcp --daemon`
    - Check if port is in use: `lsof -i :3000`
    - Try different port: `vulnzap mcp --port 3001`
  </Accordion>
  
  <Accordion title="Slow AI Responses">
    **Problem:** AI taking longer to generate code
    
    **Solutions:**
    - VulnZap adds <150ms typically
    - Check network latency to VulnZap API
    - Enable local caching: `vulnzap config set cache true`
    - Use offline mode for air-gapped environments
  </Accordion>
  
  <Accordion title="False Positives">
    **Problem:** VulnZap blocking valid code
    
    **Solutions:**
    - Provide feedback: `vulnzap feedback --false-positive`
    - Add suppression comment in code
    - Adjust sensitivity in `.vulnzap.yml`
  </Accordion>
</AccordionGroup>

## Best Practices

<AccordionGroup>
  <Accordion title="Run MCP Server as Daemon">
    ```bash
    vulnzap mcp --daemon
    ```
    
    Automatically starts with your system, always available.
  </Accordion>
  
  <Accordion title="Monitor MCP Logs">
    ```bash
    tail -f ~/.vulnzap/logs/mcp.log | grep ERROR
    ```
    
    Watch for issues in real-time.
  </Accordion>
  
  <Accordion title="Version Lock">
    ```json package.json
    {
      "devDependencies": {
        "vulnzap": "^2.1.5"
      }
    }
    ```
    
    Ensure team uses same VulnZap version for consistent MCP behavior.
  </Accordion>
  
  <Accordion title="Custom Rules for Team">
    Create `.vulnzap/mcp-rules.yml` in repo root.
    
    All team members' AI assistants will follow same security standards.
  </Accordion>
</AccordionGroup>

## Next Steps

<CardGroup cols={2}>
  <Card
    title="IDE Integration"
    icon="code"
    href="/features/ide-integration"
  >
    Complete IDE setup guide
  </Card>
  
  <Card
    title="Security Coverage"
    icon="shield"
    href="/features/security-coverage"
  >
    Learn what VulnZap detects
  </Card>
  
  <Card
    title="CLI Reference"
    icon="terminal"
    href="/integration/cli"
  >
    Command-line documentation
  </Card>
  
  <Card
    title="Troubleshooting"
    icon="wrench"
    href="/resources/troubleshooting"
  >
    Solve common issues
  </Card>
</CardGroup>

